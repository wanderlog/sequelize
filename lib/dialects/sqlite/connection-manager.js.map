{
  "version": 3,
  "sources": ["../../../src/dialects/sqlite/connection-manager.js"],
  "sourcesContent": ["'use strict';\n\nconst fs = require('fs');\nconst path = require('path');\nconst { ConnectionManager } = require('../abstract/connection-manager');\nconst { logger } = require('../../utils/logger');\n\nconst debug = logger.debugContext('connection:sqlite');\nconst dataTypes = require('../../data-types').sqlite;\nconst sequelizeErrors = require('../../errors');\nconst parserStore = require('../parserStore')('sqlite');\nconst { promisify } = require('util');\n\nexport class SqliteConnectionManager extends ConnectionManager {\n  constructor(dialect, sequelize) {\n    super(dialect, sequelize);\n\n    // We attempt to parse file location from a connection uri\n    // but we shouldn't match sequelize default host.\n    if (this.sequelize.options.host === 'localhost') {\n      delete this.sequelize.options.host;\n    }\n\n    this.connections = {};\n    this.lib = this._loadDialectModule('sqlite3');\n    this.refreshTypeParser(dataTypes);\n  }\n\n  async _onProcessExit() {\n    await Promise.all(\n      Object.getOwnPropertyNames(this.connections)\n        .map(connection => promisify(callback => this.connections[connection].close(callback))()),\n    );\n\n    return super._onProcessExit.call(this);\n  }\n\n  // Expose this as a method so that the parsing may be updated when the user has added additional, custom types\n  _refreshTypeParser(dataType) {\n    parserStore.refresh(dataType);\n  }\n\n  _clearTypeParser() {\n    parserStore.clear();\n  }\n\n  async getConnection(options) {\n    options = options || {};\n    options.uuid = options.uuid || 'default';\n\n    if (Boolean(this.sequelize.options.storage) !== null && this.sequelize.options.storage !== undefined) {\n      // Check explicitely for the storage option to not be set since an empty string signals\n      // SQLite will create a temporary disk-based database in that case.\n      options.storage = this.sequelize.options.storage;\n    } else {\n      options.storage = this.sequelize.options.host || ':memory:';\n    }\n\n    options.inMemory = options.storage === ':memory:' ? 1 : 0;\n\n    const dialectOptions = this.sequelize.options.dialectOptions;\n    const defaultReadWriteMode = this.lib.OPEN_READWRITE | this.lib.OPEN_CREATE;\n\n    options.readWriteMode = dialectOptions && dialectOptions.mode || defaultReadWriteMode;\n\n    if (this.connections[options.inMemory || options.uuid]) {\n      return this.connections[options.inMemory || options.uuid];\n    }\n\n    if (!options.inMemory && (options.readWriteMode & this.lib.OPEN_CREATE) !== 0) {\n      // automatic path provision for `options.storage`\n      fs.mkdirSync(path.dirname(options.storage), { recursive: true });\n    }\n\n    const connection = await new Promise((resolve, reject) => {\n      this.connections[options.inMemory || options.uuid] = new this.lib.Database(\n        options.storage,\n        options.readWriteMode,\n        err => {\n          if (err) {\n            return reject(new sequelizeErrors.ConnectionError(err));\n          }\n\n          debug(`connection acquired ${options.uuid}`);\n          resolve(this.connections[options.inMemory || options.uuid]);\n        },\n      );\n    });\n\n    if (this.sequelize.config.password) {\n      // Make it possible to define and use password for sqlite encryption plugin like sqlcipher\n      connection.run(`PRAGMA KEY=${this.sequelize.escape(this.sequelize.config.password)}`);\n    }\n\n    if (this.sequelize.options.foreignKeys !== false) {\n      // Make it possible to define and use foreign key constraints unless\n      // explicitly disallowed. It's still opt-in per relation\n      connection.run('PRAGMA FOREIGN_KEYS=ON');\n    }\n\n    return connection;\n  }\n\n  releaseConnection(connection, force) {\n    if (connection.filename === ':memory:' && force !== true) {\n      return;\n    }\n\n    if (connection.uuid) {\n      connection.close();\n      debug(`connection released ${connection.uuid}`);\n      delete this.connections[connection.uuid];\n    }\n  }\n}\n"],
  "mappings": "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",
  "names": []
}
